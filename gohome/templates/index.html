{% extends 'base.html' %}
{% block head %}
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
    html { height: 100% }
    body { height: 100%; margin: 0; padding: 0 }
    #map { height: 90% }
</style>
<script type="text/javascript"
    src="http://maps.googleapis.com/maps/api/js?key={{ API_KEY }}&sensor=false">
</script>
<script src="/js/jquery-1.7.1.min.js"></script>
<script type="text/javascript">

var map;
var markersArray = [];
var kmlLayersArray = [];


function initialize() {
    var latlng = new google.maps.LatLng({{ coordinate.lat }},{{ coordinate.lng }});
    var myOptions = {
        center: latlng,
        zoom: {{ zoom }},
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    map = new google.maps.Map(document.getElementById("map"),
        myOptions);
}


function addMarker(location) {
  marker = new google.maps.Marker({
    position: location,
    map: map
  });
  markersArray.push(marker);
}

// Removes the overlays from the map, but keeps them in the array
function clearOverlays() {
  if (markersArray) {
    for (i in markersArray) {
      markersArray[i].setMap(null);
    }
  }
}

// Shows any overlays currently in the array
function showOverlays() {
  if (markersArray) {
    for (i in markersArray) {
      markersArray[i].setMap(map);
    }
  }
}

// Deletes all markers in the array by removing references to them
function deleteOverlays() {
  if (markersArray) {
    for (i in markersArray) {
      markersArray[i].setMap(null);
    }
    markersArray.length = 0;
  }
}

function addKmlLayer(serv_no,serv_dir) {
    kmlLayer = new google.maps.KmlLayer('http://publictransport.sg/kml/busroutes/'+serv_no+'-'+serv_dir+'.kml');
    kmlLayer.setMap(map);
    kmlLayersArray.push(kmlLayer);
}

function deleteLayers() {
  if (kmlLayersArray) {
    for (i in kmlLayersArray) {
      kmlLayersArray[i].setMap(null);
    }
    kmlLayersArray.length = 0;
  }
}

$(document).ready(function(){
    $("#add_route").click(function(){
        var bus_service = $("#busservice_option").val();
        if (bus_service != "default")
        {
            addKmlLayer(bus_service.split("_")[0],bus_service.split("_")[1]);
        }
    });

    $("#clear_route").click(function(){
        deleteLayers();
    });

    $("#reset_marker").click(function(){
        deleteOverlays();
    });

    $("#busservice_option").keyup(function(event){
        if(event.keyCode == 13){
            $("#add_route").click();
        }
    });
});
$(window).load(function(){
    initialize();

    var contextMenu = $('#contextMenu');

    // Disable the browser context menu on our context menu
    contextMenu.bind('contextmenu', function() { return false; });

    // Append it to the map object
    $(map.getDiv()).append(contextMenu);


    // Keep track of where you clicked
    var clickedLatLng;

    // Display and position the menu
    google.maps.event.addListener(map, 'rightclick', function(e)
    {
    	// start buy hiding the context menu if its open
    	contextMenu.hide();

    	var mapDiv = $(map.getDiv()),
    		x = e.pixel.x,
    		y = e.pixel.y;

    	// save the clicked location
    	clickedLatLng = e.latLng;

    	// adjust if clicked to close to the edge of the map
    	if ( x > mapDiv.width() - contextMenu.width() )
    		x -= contextMenu.width();

    	if ( y > mapDiv.height() - contextMenu.height() )
    		y -= contextMenu.height();

    	// Set the location and fade in the context menu
    	contextMenu.css({ top: y, left: x }).fadeIn(100);
    });

    // Set some events on the context menu links
    contextMenu.find('a').click( function()
    {
    	// fade out the menu
    	contextMenu.fadeOut(75);

    	// The link's href minus the #
    	var action = $(this).attr('href').substr(1);

    	switch ( action )
    	{
            case 'markHere':
                addMarker(clickedLatLng);
                break;

    		case 'zoomIn':
    			map.setZoom(
    				map.getZoom() + 1
    			);
    			map.panTo(clickedLatLng);
    			break;

    		case 'zoomOut':
    			map.setZoom(
    				map.getZoom() - 1
    			);
    			map.panTo(clickedLatLng);
    			break;

    		case 'centerHere':
    			map.panTo(clickedLatLng);
    			break;
    	}

    	return false;
    });
    // Hover events for effect
    contextMenu.find('a').hover( function() {
    	$(this).parent().addClass('hover');
    }, function() {
    	$(this).parent().removeClass('hover');
    });

    // Hide context menu on some events
    $.each('click dragstart zoom_changed maptypeid_changed'.split(' '), function(i,name){
    	google.maps.event.addListener(map, name, function(){ contextMenu.hide() });
    });
});
</script>
<style>
#contextMenu {
	position: absolute;
	min-width: 100px;
	z-index: 1000;
	background: #fff;
	border-top: solid 1px #CCC;
	border-left: solid 1px #CCC;
	border-bottom: solid 1px #676767;
	border-right: solid 1px #676767;
	padding: 0px;
	margin: 0px;
	display:none;
}

#contextMenu a {
	color: #000;
	text-decoration: none;
	display: block;
	line-height: 22px;
	height: 22px;
	padding: 1px 10px;
}

#contextMenu li {
	list-style: none;
	padding: 1px;
	margin: 0px;
}

#contextMenu li.hover a {
	background-color: #A7C4FA;
}

#contextMenu li.separator {
	border-top: solid 1px #ccc;
}
</style>
{% endblock %}
{% block body %}
<div id="banner">
<h1>Bus Service Visualizer</h1>
<p>Visuallize all bus services available near your home or your workplace.
Reduce MRT Congestion and use Bus instead.
Simply by adding all bus services no at your destination stop,
and look for possible bus service</p>
</div>
<div id="filter" style="width:19%; float:left;">
{% include 'bus_services.html' %}
<button type="button" id="add_route">Add</button><br />
<button type="button" id="clear_route">Clear Route</button><br />
<button type="button" id="reset_marker">Reset Marker</button><br />
<a href="https://sites.google.com/site/yeoeugeneoey/contact">Support</a>
</div>
<div id="map" style="width:60%; height:80%;"></div>

<ul id="contextMenu">
    <li><a href="#markHere">Mark here</a></li>
	<li><a href="#zoomIn">Zoom in</a></li>
	<li><a href="#zoomOut">Zoom out</a></li>
	<li><a href="#centerHere">Center map here</a></li>
</ul>
{% endblock %}